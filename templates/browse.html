{% extends "base.html" %}

{% block header %}
<h2 class="text-center">{{ language }} Videos</h2>
{% endblock %}

{% block content %}
<div class="options-bar text-center">
    <label for="sortOrder" class="form-label">Sort by:</label>
    <select id="sortOrder" class="sort-order btn d-inline-block w-auto mx-2">
        <option value="newest">Newest First</option>
        <option value="oldest">Oldest First</option>
    </select>

    <label for="channelFilter" class="form-label">Filter by Channel:</label>
    <select id="channelFilter" class="selectpicker channel-filter w-auto" multiple data-live-search="true">
        {% set channel_titles = [] %}
        {% for video in videos %}
        {% if video['channel_title'] not in channel_titles %}
        {% set _ = channel_titles.append(video['channel_title']) %}
        <option value="{{ video['channel_title'] }}">{{ video['channel_title'] }}</option>
        {% endif %}
        {% endfor %}
    </select>
</div>
<div id="videoGrid" class="video-grid">
    {% for video in videos %}
    <div class="video-item" data-upload-date="{{ video['upload_date'] }}" data-channel="{{ video['channel_title'] }}">
        <div class="card h-100">
            <a href="{{ url_for('video_page', video_id=video['video_id']) }}">
                <img src="https://img.youtube.com/vi/{{ video['video_id'] }}/mqdefault.jpg" class="card-img-top"
                    alt="{{ video['title'] }}">
                    <div class="card-body text-center">
                        <h5 class="card-title">{{ video['title'] }}</h5>
                        <p class="card-text">{{ video['channel_title'] }}</p>
                        <p class="text-muted upload-date"></p> <!-- Placeholder for the formatted date -->
                    </div>
            </a>
        </div>
    </div>
    {% endfor %}
</div>
<style>
    h2 {
        font-size: 5rem;
    }

    a {
        text-decoration: none !important;
        color: black;
    }

    .options-bar {
        display: flex;
        flex-direction: row;
        align-items: center;
        padding: 0.5rem;
        margin: 1rem 0;
        border-radius: 5px;
        background-color: white;
        flex-wrap: wrap;
    }

    .options-bar .sort-order,
    .options-bar .channel-filter {
        margin: 0.5rem;
        flex: 1 1 150px;
        border-color: #ccc;
    }

    .options-bar .form-label{
        margin: 0;
        padding: 0 1rem;
    }

    .video-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 20px;
        background-color: white;
        padding: 2rem;
        border-radius: 15px;
    }

    .video-item {
        text-align: center;
        box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19);
        border-radius: 5px;
    }

    .video-item:hover {
        box-shadow: 0 4px 8px 0 hotpink, 0 6px 20px 0;
    }

    .video-item img {
        width: 100%;
        height: auto;
    }

    .video-title {
        font-size: 1rem;
        margin-top: 10px;
    }

    .channel-title {
        font-size: 0.9rem;
        margin-top: 5px;
    }

    /* Media Queries for Responsiveness */
    @media (max-width: 1200px) {
        .video-grid {
            grid-template-columns: repeat(3, 1fr);
        }
    }

    @media (max-width: 992px) {
        .video-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    @media (max-width: 768px) {
        .video-grid {
            grid-template-columns: repeat(1, 1fr);
        }        

        .options-bar .sort-order,
        .options-bar .channel-filter {
            flex: 1 1 100%;
        }

        .video-title {
            font-size: 0.9rem;
        }

        .channel-title {
            font-size: 0.8rem;
        }
    }

    @media (max-width: 576px) {
        .video-grid {
            padding: 1rem;
            gap: 10px;
        }

        .video-item {
            box-shadow: none;
        }
    }
</style>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const videoGrid = document.getElementById('videoGrid');
        const sortOrderSelect = document.getElementById('sortOrder');
        const channelFilterSelect = document.getElementById('channelFilter');

        function formatDate(dateString) {
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            return new Date(dateString).toLocaleDateString(undefined, options);
        }

        function sortVideos(order) {
            const videos = Array.from(videoGrid.getElementsByClassName('video-item'));
            videos.sort((a, b) => {
                const dateA = new Date(a.getAttribute('data-upload-date'));
                const dateB = new Date(b.getAttribute('data-upload-date'));
                return order === 'newest' ? dateB - dateA : dateA - dateB;
            });

            videos.forEach(video => videoGrid.appendChild(video));
        }

        function filterVideos(selectedChannels) {
            const videos = Array.from(videoGrid.getElementsByClassName('video-item'));
            videos.forEach(video => {
                if (selectedChannels.length === 0 || selectedChannels.includes(video.getAttribute('data-channel'))) {
                    video.style.display = '';
                } else {
                    video.style.display = 'none';
                }
            });
        }

        function getSelectedChannels() {
            return Array.from(channelFilterSelect.selectedOptions).map(option => option.value);
        }

        // Initial formatting of dates
        document.querySelectorAll('.video-item').forEach(function (item) {
            const dateString = item.getAttribute('data-upload-date');
            const formattedDate = formatDate(dateString);
            item.querySelector('.upload-date').textContent = formattedDate;
        });

        // Handle sorting when the dropdown value changes
        sortOrderSelect.addEventListener('change', () => sortVideos(sortOrderSelect.value));
        channelFilterSelect.addEventListener('change', () => filterVideos(getSelectedChannels()));

        // Initialize Bootstrap Select
        $('.selectpicker').selectpicker();

        // Initial sort by newest
        sortVideos('newest');
    });
</script>
{% endblock %}